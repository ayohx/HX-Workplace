# Story 1.4: File Attachments and Media Support

## Status

**Draft**

---

## Story

**As a** user,  
**I want** to attach images, documents, and videos to my posts,  
**so that** I can share visual content and important files with my colleagues.

---

## Acceptance Criteria

1. Post creation form allows file uploads (drag-and-drop and file picker)
2. Supported file types: images (PNG, JPG, GIF), documents (PDF, DOCX, XLSX), videos (MP4, MOV)
3. File size limits enforced: 10MB per image, 20MB per document, 50MB per video
4. Files uploaded to Supabase Storage with unique file paths and access control
5. Image attachments display inline in posts with lightbox modal for full-size viewing
6. Document attachments display as download cards with file name, type, and size
7. Video attachments display with inline video player (HTML5 video controls)
8. Multiple files can be attached to a single post (up to 5 files)
9. File deletion removes file from storage when post is deleted
10. File upload progress indicator displays during upload

### Integration Verification

**IV1: Existing Functionality Verification**
- Existing post creation flow remains functional without file attachments
- Post card layout adapts gracefully to include file attachments
- Feed rendering performance unaffected by posts with attachments
- Text-only posts continue to work exactly as before

**IV2: Integration Point Verification**
- Supabase Storage bucket correctly configured with Row Level Security
- File URLs generated from Supabase Storage are publicly accessible (with auth check)
- Post database record correctly stores file metadata (filename, type, size, storage URL)
- File upload errors display user-friendly messages (e.g., "File too large, maximum 10MB")

**IV3: Performance Impact Verification**
- Image thumbnails lazy load as user scrolls feed
- File uploads do not block post submission (background upload with progress)
- Posts with multiple images load progressively (not blocking page render)
- Video playback does not auto-play (user-initiated, bandwidth friendly)

---

## Dev Technical Guidance

### Prerequisites
**This story depends on Stories 1.1, 1.2 being complete.**
- Database schema with posts table deployed
- Social feed with posts working
- Supabase client configured

### Supabase Storage Setup
[Source: Supabase Storage Documentation]

**Storage Bucket Configuration:**
- Bucket name: `attachments`
- Public: `false` (requires authentication)
- File size limits: Configurable per file type
- Allowed MIME types: `image/*, application/pdf, application/vnd.*, video/*`

**RLS Policies for Storage:**
```sql
-- Users can upload files
CREATE POLICY "Users can upload files"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'attachments');

-- Users can read files if they have access to the post
CREATE POLICY "Users can read files"
ON storage.objects FOR SELECT
TO authenticated
USING (bucket_id = 'attachments');

-- Users can delete their own files
CREATE POLICY "Users can delete own files"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'attachments' AND owner = auth.uid());
```

### Database Schema Updates
[Source: supabase/migrations]

**Add to posts table:**
```sql
ALTER TABLE posts ADD COLUMN attachments jsonb DEFAULT '[]';
```

**Attachment JSON structure:**
```json
[
  {
    "id": "uuid",
    "type": "image|document|video",
    "filename": "example.jpg",
    "size": 1024000,
    "url": "supabase-storage-url",
    "thumbnailUrl": "optional-thumbnail-url"
  }
]
```

### File Upload Implementation
[Source: Supabase JavaScript Client]

**Upload file to storage:**
```typescript
const { data, error } = await supabase.storage
  .from('attachments')
  .upload(`${userId}/${Date.now()}_${file.name}`, file, {
    cacheControl: '3600',
    upsert: false
  });
```

**Get public URL:**
```typescript
const { data } = supabase.storage
  .from('attachments')
  .getPublicUrl(filePath);
```

### Existing Code Context
[Source: brownfield-architecture.md]

**Files to modify:**
- `src/components/feed/CreatePostCard.tsx` - Add file upload UI
- `src/components/feed/PostCard.tsx` - Display attachments
- `src/lib/api.ts` - Add file upload functions
- Create `src/components/shared/FileUploader.tsx` - Reusable file upload component
- Create `src/components/shared/AttachmentViewer.tsx` - Display attachments

**Current attachment support:**
- Mock data includes `attachment_url` and `attachment_type`
- UI already displays single attachments
- Need to expand to multiple file support

### Performance Considerations
- **Lazy loading**: Use `loading="lazy"` for images
- **Progressive enhancement**: Upload files in background
- **Optimistic UI**: Show upload progress immediately
- **Image optimization**: Generate thumbnails server-side (future enhancement)

---

## Tasks / Subtasks

- [ ] **Task 1: Configure Supabase Storage Bucket** (AC: 4)
  - [ ] Create `attachments` storage bucket in Supabase dashboard
  - [ ] Configure bucket settings:
    - Set public to `false` (authenticated only)
    - Set file size limits
    - Add allowed MIME types
  - [ ] Implement RLS policies for storage bucket
  - [ ] Test: upload file via Supabase dashboard to verify bucket works
  - [ ] Document bucket configuration in `docs/SETUP_DATABASE.md`

- [ ] **Task 2: Update Database Schema for Multiple Attachments** (AC: 8)
  - [ ] Add migration file to update posts table:
    ```sql
    ALTER TABLE posts ADD COLUMN attachments jsonb DEFAULT '[]';
    ```
  - [ ] Run migration against database
  - [ ] Update `database.types.ts` to include attachments field
  - [ ] Test: insert post with attachments JSON in database

- [ ] **Task 3: Implement File Upload Functions** (AC: 1, 2, 3, 10)
  - [ ] Create `uploadFile()` function in `src/lib/api.ts`:
    - Validate file type (images, documents, videos)
    - Validate file size (10MB, 20MB, 50MB limits)
    - Upload to Supabase Storage
    - Return file metadata (url, filename, size, type)
  - [ ] Create `deleteFile()` function:
    - Remove file from Supabase Storage
    - Update post attachments array
  - [ ] Implement upload progress tracking
  - [ ] Add error handling for upload failures
  - [ ] Test: upload each file type, verify storage and metadata

- [ ] **Task 4: Build File Upload UI Component** (AC: 1, 10)
  - [ ] Create `src/components/shared/FileUploader.tsx`:
    - Drag-and-drop zone
    - File picker button
    - File preview with remove option
    - Upload progress indicators
    - File type and size validation messages
  - [ ] Add file upload to `CreatePostCard.tsx`:
    - Integrate `FileUploader` component
    - Support multiple files (up to 5)
    - Display file previews before upload
  - [ ] Test: drag-and-drop files, verify preview and validation
  - [ ] Test: select files via picker, verify same behaviour

- [ ] **Task 5: Display Attachments in Posts** (AC: 5, 6, 7)
  - [ ] Create `src/components/shared/AttachmentViewer.tsx`:
    - Image gallery with lightbox modal
    - Document download cards (icon, name, size, download button)
    - Video player with HTML5 controls
  - [ ] Update `PostCard.tsx` to render attachments:
    - Parse `attachments` JSON from post
    - Render `AttachmentViewer` for each attachment type
    - Handle single and multiple attachments
  - [ ] Implement lightbox modal for full-size image viewing:
    - Click image to open modal
    - Navigate between multiple images
    - Close modal with ESC key or click outside
  - [ ] Test: create post with each attachment type, verify display

- [ ] **Task 6: Implement Lazy Loading for Images** (IV3)
  - [ ] Add `loading="lazy"` attribute to all image tags
  - [ ] Implement intersection observer for progressive image loading
  - [ ] Add placeholder skeleton for loading images
  - [ ] Test: scroll feed with 50+ images, verify lazy loading

- [ ] **Task 7: File Cleanup on Post Deletion** (AC: 9)
  - [ ] Update `deletePost()` function:
    - Iterate through post attachments
    - Delete each file from Supabase Storage
    - Delete post record from database
  - [ ] Add error handling for storage deletion failures
  - [ ] Test: create post with files, delete post, verify files removed from storage

- [ ] **Task 8: Integration Testing and Performance Validation** (IV1, IV2, IV3)
  - [ ] Verify text-only posts still work without attachments
  - [ ] Verify post card layout adapts to different attachment types
  - [ ] Test file size limit enforcement (try uploading oversized file)
  - [ ] Test file type validation (try uploading unsupported type)
  - [ ] Performance test: upload 5 large files, measure time and UI responsiveness
  - [ ] Performance test: scroll feed with 100+ posts containing images
  - [ ] Verify video playback does not auto-play
  - [ ] Test mobile responsiveness of file upload UI

---

## Dev Notes

**Integration Approach:**
This story adds file upload capability to the existing post system. The key is to use Supabase Storage for file hosting and store file metadata in the post record.

**Key Technical Decisions:**
1. **Multiple files**: Store attachments as JSONB array in posts table
2. **File organization**: Use `userId/timestamp_filename` path pattern for uniqueness
3. **Lazy loading**: Implement lazy image loading for feed performance
4. **Progressive upload**: Upload files in background with progress indicator

**Gotchas to Avoid:**
- Must validate file size BEFORE uploading to prevent storage quota issues
- Must delete files from storage when post is deleted (orphaned files cost money)
- Lightbox modal must prevent body scroll (UX issue)
- Video auto-play can consume bandwidth (should be user-initiated)

**Testing Strategy:**
- Unit test file validation functions (size, type)
- Integration test Supabase Storage upload/delete
- UI test drag-and-drop file upload
- Performance test image lazy loading with many images
- Mobile test file picker on iOS/Android

---

## Dev Agent Record

### Agent Model Used

*To be populated by Dev Agent during implementation*

### Debug Log References

*To be populated by Dev Agent during implementation*

### Completion Notes List

*To be populated by Dev Agent during implementation*

### File List

*To be populated by Dev Agent - List all files created, modified, or deleted during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

