# Story 1.8: Notifications System Backend Integration

## Status

**Draft**

---

## Story

**As a** user,  
**I want** to receive real-time notifications for all important activity,  
**so that** I stay informed about interactions with my content and relevant updates.

---

## Acceptance Criteria

1. Notifications created in database for all user actions: post likes, comments, reactions, mentions, group invites, messages
2. Real-time notification delivery using Supabase real-time (notifications appear instantly)
3. Notification bell icon displays unread count badge
4. Notifications dropdown shows recent notifications (last 20) with infinite scroll for more
5. Clicking notification marks as read and navigates to relevant content (post, message, group)
6. Notifications display appropriate icon, message, and timestamp (e.g., "John Smith liked your post")
7. Notification preferences allow users to enable/disable specific notification types
8. Email digest notifications sent daily for important unread notifications (configurable)
9. Browser push notifications for messages and mentions (opt-in, user-configurable)
10. Notification history page shows all notifications with filtering (all, unread, mentions, messages)

### Integration Verification

**IV1: Existing Functionality Verification**
- Existing `NotificationsDropdown` component continues to display notification UI
- Notification icon in header displays correctly with unread badge
- Notification interaction (click to read, navigate) works as expected
- Settings page notification preferences section remains functional

**IV2: Integration Point Verification**
- Notification creation triggers (post like, comment, etc.) correctly save to database
- Real-time notification subscription updates notification count in real-time
- Notification read/unread status persists across sessions
- Notification links correctly route to relevant content (post ID, message thread, group)

**IV3: Performance Impact Verification**
- Notification count updates within 200ms of action
- Notifications dropdown loads under 300ms (even with 100+ notifications)
- Real-time notification subscription does not degrade app performance
- Email digest generation processes efficiently in background job

---

## Dev Technical Guidance

### Prerequisites
**Depends on Stories 1.2 (Posts), 1.3 (Comments), 1.6 (Messages) being complete.**

### Database Schema
[Source: supabase/migrations/20251115000000_complete_schema.sql]

**notifications table:**
```sql
id: uuid (primary key)
user_id: uuid (foreign key to profiles) -- recipient
actor_id: uuid (foreign key to profiles) -- who triggered notification
type: text ('like', 'comment', 'reaction', 'mention', 'group_invite', 'message')
entity_type: text ('post', 'comment', 'message', 'group')
entity_id: uuid -- ID of related entity
message: text -- formatted message
read_at: timestamptz (null if unread)
created_at: timestamptz
```

### Notification Triggers
**Implement notification creation for:**
- Post liked → Notify post author
- Post commented → Notify post author
- Post reacted → Notify post author
- User mentioned (@username) → Notify mentioned user
- Group invite → Notify invited user
- New message → Notify recipient

### Real-Time Notifications
```typescript
const subscription = supabase
  .channel(`notifications:${userId}`)
  .on('postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: `user_id=eq.${userId}`
    },
    (payload) => {
      // Update notification count
      // Show toast notification
    }
  )
  .subscribe();
```

---

## Tasks / Subtasks

- [ ] **Task 1: Implement Notification Creation Functions** (AC: 1)
  - [ ] Create `createNotification(userId, actorId, type, entityType, entityId, message)`
  - [ ] Add notification triggers to:
    - `likePost()` → notify post author
    - `createComment()` → notify post author
    - `addReaction()` → notify post author
    - Post/comment with @mentions → notify mentioned users
    - `inviteToGroup()` → notify invited user
    - `sendMessage()` → notify recipient
  - [ ] Test: trigger each action, verify notification created

- [ ] **Task 2: Real-Time Notification Delivery** (AC: 2, 3)
  - [ ] Implement real-time subscription for user notifications
  - [ ] Update unread count in real-time when notification arrives
  - [ ] Display toast notification for new notifications
  - [ ] Test: multi-browser, trigger notification, verify real-time delivery

- [ ] **Task 3: Notifications Dropdown UI** (AC: 4, 5, 6)
  - [ ] Implement `getNotifications(userId, page)` function (20 per page)
  - [ ] Implement `markAsRead(notificationId)` function
  - [ ] Update dropdown to display database notifications
  - [ ] Implement click handler to navigate to entity and mark as read
  - [ ] Format notification messages with icons and timestamps
  - [ ] Test: click notification, verify navigation and marked read

- [ ] **Task 4: Notification Preferences** (AC: 7)
  - [ ] Add notification preferences to user settings
  - [ ] Store preferences in `profiles.settings.notifications`
  - [ ] Filter notification creation based on user preferences
  - [ ] UI for enabling/disabling notification types
  - [ ] Test: disable likes, verify no like notifications received

- [ ] **Task 5: Email Digest Notifications** (AC: 8)
  - [ ] Create Supabase Edge Function for email digest
  - [ ] Query unread notifications from last 24 hours
  - [ ] Format email template with notifications
  - [ ] Send via email service (SendGrid, Resend, or similar)
  - [ ] Schedule daily cron job
  - [ ] Test: trigger manually, verify email sent

- [ ] **Task 6: Browser Push Notifications** (AC: 9)
  - [ ] Implement push notification service worker
  - [ ] Request notification permission (opt-in)
  - [ ] Store push subscription in database
  - [ ] Trigger push notification for messages and mentions
  - [ ] Test: send message, verify push notification appears

- [ ] **Task 7: Notification History Page** (AC: 10)
  - [ ] Create notification history page with filtering
  - [ ] Filter options: All, Unread, Mentions, Messages, Likes, Comments
  - [ ] Implement pagination for history (50 per page)
  - [ ] Test: filter by type, verify correct notifications shown

- [ ] **Task 8: Integration Testing** (IV1, IV2, IV3)
  - [ ] Verify existing NotificationsDropdown works with database
  - [ ] Test notification count updates within 200ms
  - [ ] Test dropdown loads under 300ms with 100+ notifications
  - [ ] Verify notification links route correctly
  - [ ] Performance test real-time subscription impact

---

## Dev Notes

**Integration Approach:**
Notifications are triggered by user actions throughout the app. Each action (like, comment, message) creates a notification entry for the relevant user. Real-time subscriptions deliver notifications instantly.

**Key Technical Decisions:**
1. **Notification table**: Centralized table for all notification types
2. **Real-time per-user**: Subscribe to notifications for current user only
3. **Message formatting**: Store pre-formatted message in database
4. **Email digest**: Supabase Edge Function with cron trigger

**Gotchas:**
- Don't notify users of their own actions
- Respect notification preferences before creating
- Batch email digests to avoid spam (once per day max)
- Push notifications require HTTPS and user permission

---

## Dev Agent Record

### Agent Model Used

*To be populated by Dev Agent during implementation*

### Debug Log References

*To be populated by Dev Agent during implementation*

### Completion Notes List

*To be populated by Dev Agent during implementation*

### File List

*To be populated by Dev Agent - List all files created, modified, or deleted during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

