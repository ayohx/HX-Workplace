# Story 1.12: Knowledge Library and Resource Sharing

## Status

**Draft**

---

## Story

**As a** user,  
**I want** a centralised knowledge library for storing and discovering company resources,  
**so that** I can access important documents, guides, and shared knowledge easily.

---

## Acceptance Criteria

1. Knowledge library page displays categorised resources (folders, documents, links)
2. Users can upload documents (PDF, DOCX, XLSX) to library with title, description, category
3. Resources organised by categories (Policies, Training, Templates, Announcements, etc.)
4. Users can search resources by title, description, tags, file content (future)
5. Resource cards display: title, type icon, upload date, uploader, download count
6. Clicking resource opens preview (PDF/images) or downloads file (other types)
7. Users can favourite resources for quick access
8. Resource permissions: public (all users), group-specific, role-specific
9. Version control: users can upload new versions of existing resources
10. Resource activity tracking: view count, download count, last accessed date

### Integration Verification

**IV1:** Library page navigates correctly, file upload UI consistent with posts, resource cards reuse existing components  
**IV2:** Files saved to Supabase Storage, metadata in database, permissions enforced by RLS  
**IV3:** Library page loads <1s, file upload <5s for 20MB, search <500ms, file preview <2s

---

## Dev Technical Guidance

### Prerequisites
**Depends on Story 1.4 (File Attachments) being complete for file upload patterns.**

### Database Schema
[Source: Add to migrations]

**resources table:**
```sql
id: uuid
title: text
description: text
category: text
file_url: text (Supabase Storage URL)
file_type: text (PDF, DOCX, XLSX, link)
file_size: bigint
version: integer (default 1)
parent_id: uuid (for version history)
uploaded_by: uuid (foreign key profiles)
permissions: text ('public', 'group', 'role')
permission_ids: uuid[] (group/role IDs if restricted)
tags: text[]
view_count: integer (default 0)
download_count: integer (default 0)
created_at, updated_at
```

**resource_favourites junction table:**
```sql
user_id: uuid (foreign key profiles)
resource_id: uuid (foreign key resources)
created_at
PRIMARY KEY (user_id, resource_id)
```

### File Storage
- **Storage bucket**: Create `resources` bucket in Supabase
- **File path**: `resources/{category}/{uuid}.{ext}`
- **Access**: Public URLs for public resources, signed URLs for restricted

---

## Tasks / Subtasks

- [ ] **Task 1: Resources Database Schema** (AC: 1, 2, 3)
  - [ ] Create resources table migration
  - [ ] Create resource_favourites table
  - [ ] Create resources storage bucket
  - [ ] Test: create resource, verify saved

- [ ] **Task 2: Resource Upload** (AC: 2)
  - [ ] Implement `uploadResource(file, title, description, category, permissions)` function
  - [ ] Upload file to Supabase Storage
  - [ ] Save metadata to resources table
  - [ ] Test: upload PDF, verify accessible

- [ ] **Task 3: Knowledge Library UI** (AC: 1, 5)
  - [ ] Create knowledge library page
  - [ ] Display resources by category
  - [ ] Resource cards with title, icon, date, uploader
  - [ ] Test: navigate to library, verify resources display

- [ ] **Task 4: Resource Search** (AC: 4)
  - [ ] Implement search across title, description, tags
  - [ ] Add search bar to library page
  - [ ] Test: search query, verify results

- [ ] **Task 5: Resource Preview and Download** (AC: 6)
  - [ ] Implement PDF preview (iframe or PDF.js)
  - [ ] Implement file download with tracking
  - [ ] Increment download_count on download
  - [ ] Test: preview PDF, download file

- [ ] **Task 6: Favourites** (AC: 7)
  - [ ] Implement favourite/unfavourite functions
  - [ ] Display favourites section in library
  - [ ] Test: favourite resource, verify saves

- [ ] **Task 7: Resource Permissions** (AC: 8)
  - [ ] Implement permission check before displaying resource
  - [ ] RLS policies enforce permissions
  - [ ] Test: public vs restricted resources

- [ ] **Task 8: Version Control** (AC: 9)
  - [ ] Implement version upload (links to parent_id)
  - [ ] Display version history on resource page
  - [ ] Test: upload v2, verify version history

- [ ] **Task 9: Activity Tracking** (AC: 10)
  - [ ] Increment view_count on resource view
  - [ ] Display stats on resource page
  - [ ] Test: view resource, verify count incremented

- [ ] **Task 10: Integration Testing** (IV1, IV2, IV3)
  - [ ] Performance test library load time
  - [ ] Test file upload for 20MB file
  - [ ] Test search performance
  - [ ] Verify permissions enforced

---

## Dev Notes

**Key Decisions:**
1. **Supabase Storage**: Use separate bucket for resources (separate from post attachments)
2. **Version control**: Track versions via parent_id relationship
3. **Permissions**: RLS policies enforce access control

**Gotchas:**
- PDF preview requires PDF.js or iframe (iframe simpler but less feature-rich)
- File size limits: enforce 50MB max per resource
- Version history must link correctly to avoid orphaned versions

---

## Dev Agent Record

*To be populated by Dev Agent during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

