# Story 1.7: Group Chats and Multi-Participant Messaging

## Status

**Draft**

---

## Story

**As a** user,  
**I want** to create group chats with multiple colleagues,  
**So that** I can have team discussions and coordinate with multiple people efficiently.

---

## Acceptance Criteria

1. Users can create group chats and invite multiple participants (3-50 participants)
2. Group chat creation saves to database with creator as admin and all participants added
3. Group chat messages display with sender name and avatar (since multiple participants)
4. Users can leave group chats (except creator/admin must transfer ownership first)
5. Group chat admins can add/remove participants
6. Group chat name can be customised by admin (default: participant names comma-separated)
7. Real-time message updates for all group chat participants
8. Typing indicators show "Name is typing..." for group chats
9. Read receipts show read count and list of readers (e.g., "Read by 3 people")
10. Group chat notifications follow same unread logic as direct messages

### Integration Verification

**IV1: Existing Functionality Verification**
- Existing messaging page UI seamlessly includes group chats in conversation list
- Message bubble components correctly handle group chat messages (show sender name)
- Conversation switching between direct messages and group chats works smoothly
- Message input and sending experience consistent across chat types

**IV2: Integration Point Verification**
- Group chat database schema distinguishes between direct and group conversations
- Participant management updates conversation membership table
- Real-time subscriptions handle multi-participant message delivery efficiently
- Unread count logic correctly accounts for group chat messages

**IV3: Performance Impact Verification**
- Group chat message delivery latency under 300ms to all participants
- Group chat with 50 participants does not degrade message sending performance
- Typing indicators in group chats do not overwhelm real-time system (max 3 visible)
- Read receipt calculations perform efficiently (cached per message)

---

## Dev Technical Guidance

### Prerequisites
**Depends on Story 1.6 (Direct Messaging) being complete.**

### Database Schema Extensions
[Source: supabase/migrations]

**Add to conversations table:**
```sql
ALTER TABLE conversations ADD COLUMN type text DEFAULT 'direct'; -- 'direct' or 'group'
ALTER TABLE conversations ADD COLUMN name text; -- custom group name
```

**Extend conversation_participants:**
- Already supports multiple participants per conversation
- Add role: 'admin' or 'member' for group chats

### Key Implementation Points
- **Group identification**: Use `conversation.type = 'group'` and participant count > 2
- **Multi-user subscriptions**: All participants subscribe to same conversation channel
- **Read receipts**: Aggregate read count across all participants
- **Typing indicators**: Show max 3 typing users at once to prevent UI clutter

---

## Tasks / Subtasks

- [ ] **Task 1: Extend Conversation Schema for Group Chats** (AC: 1, 2, 6)
  - [ ] Add migration for conversation type and name fields
  - [ ] Update TypeScript types
  - [ ] Modify `createConversation()` to support group type with multiple participants
  - [ ] Test: create group conversation with 5 participants

- [ ] **Task 2: Group Chat Message Display** (AC: 3)
  - [ ] Update message bubble component to show sender name/avatar for group chats
  - [ ] Differentiate between direct (no sender name) and group (with sender name)
  - [ ] Test: display messages in group chat vs direct message

- [ ] **Task 3: Participant Management** (AC: 4, 5)
  - [ ] Implement `addParticipant(conversationId, userId)` function (admin only)
  - [ ] Implement `removeParticipant(conversationId, userId)` function (admin only)
  - [ ] Implement `leaveGroupChat(conversationId)` function (transfer ownership first if admin)
  - [ ] Add UI for participant management in group chat header
  - [ ] Test: add participant, remove participant, leave group

- [ ] **Task 4: Real-Time Multi-Participant Message Delivery** (AC: 7)
  - [ ] Verify existing real-time subscription works for multiple participants
  - [ ] Test: send message in group chat with 10 participants, verify all receive
  - [ ] Optimize subscription to prevent duplicate notifications

- [ ] **Task 5: Group Chat Typing Indicators** (AC: 8)
  - [ ] Extend typing indicator logic for multiple users
  - [ ] Display "User1, User2, and User3 are typing..." (limit to 3)
  - [ ] Test: multi-browser, verify typing indicators show correctly

- [ ] **Task 6: Group Chat Read Receipts** (AC: 9)
  - [ ] Implement read count aggregation across participants
  - [ ] Display "Read by X people" with tooltip showing names
  - [ ] Test: mark message as read, verify count updates

- [ ] **Task 7: Integration Testing** (IV1, IV2, IV3)
  - [ ] Verify group chats appear in conversation list alongside direct messages
  - [ ] Performance test: 50-participant group chat message delivery (target <300ms)
  - [ ] Test typing indicator performance with multiple typers
  - [ ] Verify read receipt calculation efficiency

---

## Dev Notes

**Integration Approach:**
Group chats extend the existing messaging infrastructure. The key is supporting multiple participants on the same conversation with proper role management (admin vs member).

**Key Technical Decisions:**
1. **Type field**: Use `conversation.type` to distinguish direct vs group
2. **Admin roles**: Track admin status in `conversation_participants.role`
3. **Name fallback**: Auto-generate name from participant names if not customised
4. **Typing indicator limit**: Show max 3 typing users to prevent UI clutter

**Gotchas:**
- Admin cannot leave group without transferring ownership
- Must notify all participants when someone joins/leaves
- Read receipts for 50 participants must be efficient (aggregate, not individual queries)

---

## Dev Agent Record

### Agent Model Used

*To be populated by Dev Agent during implementation*

### Debug Log References

*To be populated by Dev Agent during implementation*

### Completion Notes List

*To be populated by Dev Agent during implementation*

### File List

*To be populated by Dev Agent - List all files created, modified, or deleted during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

