# Story 1.5: Groups and Communities Backend Integration

## Status

**Draft**

---

## Story

**As a** user,  
**I want** to create and join groups with dedicated feeds and member management,  
**so that** I can collaborate with specific teams and interest-based communities.

---

## Acceptance Criteria

1. Users can create new groups with name, description, privacy setting (public, private, secret)
2. Group creation saves to database with creator as first admin
3. Users can browse all public groups and search by name/description
4. Users can join public groups immediately, request to join private groups
5. Group admins can approve/reject join requests for private groups
6. Group detail page displays group-specific post feed from database
7. Posts in groups are visible only to group members (RLS policy enforcement)
8. Group membership list displays all members with role badges (admin, member)
9. Group admins can manage members (remove members, promote to admin)
10. Groups page displays user's groups and suggested groups based on department

### Integration Verification

**IV1: Existing Functionality Verification**
- Existing `GroupsPage` component continues to display groups list
- `GroupDetailPage` route and layout remain functional
- Group card components display group information correctly
- Navigation between groups page and group detail works seamlessly

**IV2: Integration Point Verification**
- Group creation form validates required fields and saves to database
- Group membership queries correctly filter posts for group-specific feeds
- RLS policies prevent non-members from viewing private group content
- Group admin actions (member removal, role changes) update database and UI

**IV3: Performance Impact Verification**
- Groups list loads under 500ms (paginated for 100+ groups)
- Group detail page renders feed within 1 second
- Group membership check happens server-side (not client-side leak of private data)
- Real-time group feed updates do not impact main feed performance

---

## Dev Technical Guidance

### Prerequisites
**This story depends on Stories 1.1, 1.2 being complete.**
- Database schema with groups and group_members tables
- Posts system working
- RLS policies infrastructure established

### Relevant Database Tables
[Source: supabase/migrations/20251115000000_complete_schema.sql]

**groups table:**
```sql
id: uuid (primary key)
name: text
description: text
privacy: text ('public', 'private', 'secret')
owner_id: uuid (foreign key to profiles)
created_at: timestamptz
```

**group_members table:**
```sql
id: uuid (primary key)
group_id: uuid (foreign key to groups)
user_id: uuid (foreign key to profiles)
role: text ('admin', 'member')
status: text ('active', 'pending')
joined_at: timestamptz
UNIQUE(group_id, user_id)
```

**posts table update:**
```sql
ALTER TABLE posts ADD COLUMN group_id uuid REFERENCES groups(id);
```

### RLS Policies for Groups
[Source: Database security requirements]

**Group visibility:**
```sql
-- Public groups visible to all
-- Private groups visible to members
-- Secret groups visible only to members (not in search)
CREATE POLICY "Group visibility"
ON groups FOR SELECT
USING (
  privacy = 'public' 
  OR 
  id IN (
    SELECT group_id FROM group_members 
    WHERE user_id = auth.uid() AND status = 'active'
  )
);
```

**Group posts RLS:**
```sql
CREATE POLICY "Group posts visible to members"
ON posts FOR SELECT
USING (
  group_id IS NULL -- global feed posts
  OR
  group_id IN (
    SELECT group_id FROM group_members
    WHERE user_id = auth.uid() AND status = 'active'
  )
);
```

### Existing Code Context
[Source: brownfield-architecture.md]

**Files to modify:**
- `src/lib/api.ts` - Group CRUD functions
- `src/pages/Groups.tsx` - Groups listing
- `src/pages/GroupDetail.tsx` - Group detail and feed
- `src/components/groups/GroupCard.tsx` - Group display
- `src/components/groups/CreateGroupModal.tsx` - Group creation

**Current state:**
- Groups use mock data
- Need full CRUD integration
- Member management UI exists but not functional

---

## Tasks / Subtasks

- [ ] **Task 1: Implement Group CRUD API Functions** (AC: 1, 2, 3)
  - [ ] Create `createGroup()` function:
    - Insert group with owner as creator
    - Auto-add creator as admin member
    - Return group object
  - [ ] Create `getGroups()` function:
    - Query groups respecting RLS (public + user's groups)
    - Include member count
    - Support pagination and search
  - [ ] Create `updateGroup()` function (admin only)
  - [ ] Create `deleteGroup()` function (owner only)
  - [ ] Test: create, list, update, delete groups

- [ ] **Task 2: Implement Group Membership Functions** (AC: 4, 5, 8, 9)
  - [ ] Create `joinGroup()` function:
    - Public groups: add member immediately (status 'active')
    - Private groups: create join request (status 'pending')
  - [ ] Create `leaveGroup()` function
  - [ ] Create `approveJoinRequest()` function (admin only)
  - [ ] Create `rejectJoinRequest()` function (admin only)
  - [ ] Create `removeMember()` function (admin only)
  - [ ] Create `promoteMember()` function (admin only, change role)
  - [ ] Test: join, leave, approve, reject, remove, promote

- [ ] **Task 3: Group Posts Integration** (AC: 6, 7)
  - [ ] Update `createPost()` to accept `group_id` parameter
  - [ ] Update `getPosts()` to filter by `group_id`
  - [ ] Implement group feed query:
    ```typescript
    const { data, error } = await supabase
      .from('posts')
      .select(`*, profiles(*)`)
      .eq('group_id', groupId)
      .order('created_at', { ascending: false });
    ```
  - [ ] Verify RLS prevents non-members from viewing private group posts
  - [ ] Test: create post in group, verify only members can see it

- [ ] **Task 4: Group Search and Discovery** (AC: 3, 10)
  - [ ] Implement group search function:
    - Full-text search on name and description
    - Filter by privacy setting
    - Respect RLS (secret groups not in search for non-members)
  - [ ] Implement suggested groups:
    - Groups from user's department
    - Groups user is not yet a member of
    - Order by member count or activity
  - [ ] Test: search groups, verify results respect RLS

- [ ] **Task 5: Real-Time Group Updates**
  - [ ] Set up real-time subscription for group feed:
    - Subscribe to new posts in group
    - Update UI when posts added
  - [ ] Set up subscription for membership changes:
    - Update member list when members join/leave
    - Update UI when user becomes admin
  - [ ] Test: multi-browser, verify real-time updates

- [ ] **Task 6: Integration Testing and Performance Validation** (IV1, IV2, IV3)
  - [ ] Verify existing GroupsPage displays groups correctly
  - [ ] Verify group creation form validation
  - [ ] Test RLS: non-member cannot view private group posts
  - [ ] Test RLS: secret groups not visible in search
  - [ ] Performance test: load 100+ groups (target <500ms)
  - [ ] Performance test: group feed load (target <1s)
  - [ ] Verify real-time group feed doesn't impact main feed

---

## Dev Notes

**Integration Approach:**
Groups require robust RLS policies to ensure privacy. The key challenge is implementing the three privacy levels (public, private, secret) with proper member access control.

**Key Technical Decisions:**
1. **Three privacy levels**: Public (discoverable), Private (invitation/request), Secret (invisible to non-members)
2. **Join workflows**: Immediate for public, request-based for private
3. **RLS enforcement**: Server-side access control prevents data leaks
4. **Real-time feeds**: Per-group subscriptions for live updates

**Gotchas to Avoid:**
- RLS policies must cover all edge cases (public, private, secret, pending members)
- Secret groups must not appear in search results for non-members
- Group deletion must cascade to posts and members
- Admin promotion must validate current user is admin

**Testing Strategy:**
- Unit test group CRUD functions
- Integration test RLS policies (attempt unauthorized access)
- Real-time test: multi-browser group interactions
- Performance test with 100+ groups and members

---

## Dev Agent Record

### Agent Model Used

*To be populated by Dev Agent during implementation*

### Debug Log References

*To be populated by Dev Agent during implementation*

### Completion Notes List

*To be populated by Dev Agent during implementation*

### File List

*To be populated by Dev Agent - List all files created, modified, or deleted during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

