# Story 1.3: Comments and Reactions System Integration

## Status

**Draft**

---

## Story

**As a** user,  
**I want** to comment on posts and react with different emotions,  
**so that** I can engage more expressively with colleagues' content and have conversations.

---

## Acceptance Criteria

1. Comments can be created, edited, and deleted on posts with database persistence
2. Comment threads display chronologically with newest first (configurable)
3. Real-time comment updates: new comments appear without page refresh
4. Comment author information correctly loaded from database (profile picture, name)
5. Comment edit and delete restricted to comment author (with admin override)
6. Comment count on posts updates in real-time as comments are added
7. Reactions extended beyond "like" to include: love, celebrate, insightful, curious (5 reaction types)
8. Users can change their reaction type (e.g., from like to love) without creating duplicates
9. Reaction counts display per reaction type with user list on hover/click
10. Current user's reaction visually indicated on post

### Integration Verification

**IV1: Existing Functionality Verification**
- Existing `CommentList` component continues to display comments correctly
- Comment form submission and validation behaviour unchanged
- Post card displays comment count accurately
- Like button functionality preserved (now "like" reaction)

**IV2: Integration Point Verification**
- Comment creation/deletion updates post comment count
- Real-time comment subscriptions isolated per post (no global listener overhead)
- Reaction changes update database atomically (prevent duplicate reactions)
- Comment editing UI integrates seamlessly with existing post editing patterns

**IV3: Performance Impact Verification**
- Comment submission appears optimistically within 100ms
- Comment thread with 50+ comments loads under 500ms
- Reaction count updates within 200ms of user click
- Real-time comment subscription does not degrade feed scroll performance

---

## Dev Technical Guidance

### Prerequisites
**This story depends on Stories 1.1 and 1.2 being complete.**
- Database schema with comments and reactions tables deployed
- Social feed with posts working
- Real-time subscriptions infrastructure established

### Relevant Database Tables
[Source: supabase/migrations/20251115000000_complete_schema.sql]

**comments table:**
```sql
id: uuid (primary key)
post_id: uuid (foreign key to posts)
user_id: uuid (foreign key to profiles)
content: text
created_at: timestamptz
updated_at: timestamptz
```

**reactions table:**
```sql
id: uuid (primary key)
post_id: uuid (foreign key to posts)
user_id: uuid (foreign key to profiles)
type: text ('like', 'love', 'celebrate', 'insightful', 'curious')
created_at: timestamptz
UNIQUE(post_id, user_id) -- prevents duplicate reactions
```

### Existing Code Context
[Source: brownfield-architecture.md]

**Files to modify:**
- `src/lib/api.ts` - Comment CRUD, reaction functions
- `src/components/feed/PostCard.tsx` - Reaction button UI
- `src/components/feed/CommentList.tsx` - Comment display
- `src/components/feed/CommentForm.tsx` - Comment creation

**Current state:**
- Comments use mock data in `mockData.ts`
- Only "like" reaction exists (simple counter)
- Need to expand to 5 reaction types with user tracking

### Technical Implementation Details

**Comment Real-Time Subscription (per post):**
```typescript
const subscription = supabase
  .channel(`comments:${postId}`)
  .on('postgres_changes',
    {
      event: '*', // INSERT, UPDATE, DELETE
      schema: 'public',
      table: 'comments',
      filter: `post_id=eq.${postId}`
    },
    (payload) => {
      // Update comment list
    }
  )
  .subscribe();
```

**Reaction Upsert Pattern:**
```typescript
// Change reaction type or add new reaction
const { data, error } = await supabase
  .from('reactions')
  .upsert(
    { post_id, user_id, type: 'love' },
    { onConflict: 'post_id,user_id' }
  );
```

**Comment Query with Author:**
```typescript
const { data, error } = await supabase
  .from('comments')
  .select(`
    *,
    profiles:user_id (
      id, name, avatar
    )
  `)
  .eq('post_id', postId)
  .order('created_at', { ascending: false });
```

### Performance Considerations
- **Per-post subscriptions**: Each post gets its own real-time channel (cleanup critical)
- **Reaction aggregation**: Aggregate reaction counts in single query
- **Optimistic UI**: Show comment/reaction immediately, confirm asynchronously
- **Pagination**: Load initial 10 comments, "load more" for older comments

---

## Tasks / Subtasks

- [ ] **Task 1: Implement Comment CRUD API Functions** (AC: 1, 4, 5)
  - [ ] Create `createComment()` in `src/lib/api.ts`:
    - Insert comment with `post_id`, `user_id`, `content`
    - Return comment with author profile joined
  - [ ] Create `updateComment()` function:
    - Check authorization (user_id matches)
    - Update comment content and `updated_at`
  - [ ] Create `deleteComment()` function:
    - Check authorization (user_id matches or admin)
    - Hard delete (or soft delete if audit trail needed)
  - [ ] Create `getComments(postId)` function:
    - Query comments with author profiles joined
    - Order by `created_at` descending
    - Limit to 10 initial comments
  - [ ] Add error handling for all functions
  - [ ] Test: create, edit, delete comments via Supabase

- [ ] **Task 2: Real-Time Comment Updates** (AC: 3, 6)
  - [ ] Implement per-post real-time subscription in `CommentList` component:
    - Subscribe to `INSERT`, `UPDATE`, `DELETE` events
    - Filter by `post_id`
    - Update local comment state
  - [ ] Update comment count on post card when new comment added
  - [ ] Implement subscription cleanup on component unmount
  - [ ] Test: add comment in different browser, verify it appears in real-time
  - [ ] Test: delete comment, verify it disappears in real-time
  - [ ] Verify subscription memory leaks don't occur (mount/unmount test)

- [ ] **Task 3: Extend Reaction System to 5 Types** (AC: 7, 8, 9, 10)
  - [ ] Create `addReaction()` function using upsert pattern:
    ```typescript
    await supabase
      .from('reactions')
      .upsert(
        { post_id, user_id, type },
        { onConflict: 'post_id,user_id' }
      );
    ```
  - [ ] Create `removeReaction()` function:
    - Delete reaction by `post_id` and `user_id`
  - [ ] Create `getReactions(postId)` function:
    - Aggregate reaction counts by type
    - Return user list for each reaction type
  - [ ] Update `PostCard.tsx` to show all 5 reaction types:
    - Like üëç, Love ‚ù§Ô∏è, Celebrate üéâ, Insightful üí°, Curious ü§î
  - [ ] Implement reaction type selector UI (hover/click menu)
  - [ ] Highlight current user's reaction on post
  - [ ] Show user list on reaction count hover
  - [ ] Test: change reaction type, verify database updates correctly

- [ ] **Task 4: Optimistic UI for Comments and Reactions** (AC: 1, 8, IV3)
  - [ ] Implement optimistic comment creation:
    - Add comment to local state immediately with temporary ID
    - Call API in background
    - Replace with real comment when confirmed
    - Revert on error
  - [ ] Implement optimistic reaction updates:
    - Update reaction count immediately
    - Call API in background
    - Revert on failure
  - [ ] Test: disable network, verify optimistic updates work
  - [ ] Test: re-enable network, verify database sync

- [ ] **Task 5: Comment Sorting and Pagination** (AC: 2)
  - [ ] Implement comment sorting options:
    - Newest first (default)
    - Oldest first
  - [ ] Add "Load More Comments" button:
    - Load next 10 comments
    - Track offset for pagination
  - [ ] Store sort preference in localStorage
  - [ ] Test: load 50+ comments with pagination

- [ ] **Task 6: Integration Testing and Performance Validation** (IV1, IV2, IV3)
  - [ ] Verify `CommentList` component renders database comments correctly
  - [ ] Verify comment form validation still works
  - [ ] Test comment count updates when comments added/deleted
  - [ ] Performance test: comment submission time (target <100ms optimistic)
  - [ ] Performance test: load 50+ comments (target <500ms)
  - [ ] Performance test: reaction update time (target <200ms)
  - [ ] Verify per-post subscriptions don't leak memory
  - [ ] Verify real-time comments don't degrade feed scroll performance
  - [ ] Test reaction upsert prevents duplicate reactions
  - [ ] Test reaction type changes work atomically

---

## Dev Notes

**Integration Approach:**
This story expands the engagement system from simple likes to rich comments and 5 reaction types. The key challenge is managing per-post real-time subscriptions efficiently and ensuring reaction uniqueness.

**Key Technical Decisions:**
1. **Per-post subscriptions**: Each post gets its own real-time channel for comments
2. **Reaction upsert**: Use database `UNIQUE` constraint + `upsert()` to prevent duplicates
3. **Optimistic UI**: Critical for perceived performance (<100ms comment submit)
4. **Pagination**: Load 10 comments initially, "load more" for older ones

**Gotchas to Avoid:**
- Must unsubscribe from comment channels when post unmounts (memory leak risk)
- Reaction upsert must use `onConflict` to prevent duplicate reactions
- Comment count on post must update when real-time comment added
- Don't create global comment subscription (too expensive, use per-post)

**Testing Strategy:**
- Unit test comment CRUD functions
- Integration test reaction upsert logic (change reaction type)
- Real-time test: multi-browser comment creation
- Performance test: 50+ comments load time
- Memory leak test: mount/unmount components with subscriptions

---

## Dev Agent Record

### Agent Model Used

*To be populated by Dev Agent during implementation*

### Debug Log References

*To be populated by Dev Agent during implementation*

### Completion Notes List

*To be populated by Dev Agent during implementation*

### File List

*To be populated by Dev Agent - List all files created, modified, or deleted during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

