# Story 1.11: Content Moderation and Admin Dashboard

## Status

**Draft**

---

## Story

**As an** admin,  
**I want** content moderation tools and admin dashboard to manage platform safety,  
**so that** I can respond to reports, moderate content, and manage users effectively.

---

## Acceptance Criteria

1. Users can report posts, comments, messages for: spam, harassment, inappropriate content, misinformation
2. Reports submitted to database with reporter, reported content, reason, timestamp
3. Admin dashboard displays all reports with filtering: status (pending, reviewed, resolved), type, date
4. Admins can view reported content in context (full post/comment thread, user profile)
5. Admin actions: approve (no action), hide content, delete content, warn user, suspend user, ban user
6. Admin actions logged with admin ID, action type, reason, timestamp for audit trail
7. Content moderation queue prioritises based on: report count (multiple reports = higher priority), severity, age
8. Admins can add moderation notes visible to other admins (internal comments)
9. Automated content filtering flags potential violations (profanity, banned words) for review
10. Admin dashboard displays platform statistics: user count, post count, active users, reports count

### Integration Verification

**IV1:** Report button appears on posts/comments, admin nav routes to dashboard, existing UI components reused  
**IV2:** Reports saved correctly, moderation actions update database, RLS prevents non-admins accessing reports  
**IV3:** Admin dashboard loads <2s, moderation queue processes actions <500ms, audit log queryable

---

## Dev Technical Guidance

### Prerequisites
**Depends on Stories 1.2 (Posts), 1.3 (Comments) being complete.**

### Database Schema
[Source: Add to migrations]

**reports table:**
```sql
id: uuid
reporter_id: uuid (foreign key profiles)
reported_entity_type: text ('post', 'comment', 'user', 'message')
reported_entity_id: uuid
reason: text ('spam', 'harassment', 'inappropriate', 'misinformation', 'other')
description: text
status: text ('pending', 'reviewed', 'resolved')
created_at, updated_at
```

**moderation_actions table:**
```sql
id: uuid
admin_id: uuid (foreign key profiles)
report_id: uuid (foreign key reports)
action_type: text ('approve', 'hide', 'delete', 'warn', 'suspend', 'ban')
reason: text
notes: text (admin internal notes)
created_at
```

### Admin Role Check
```typescript
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', userId)
  .single();

const isAdmin = profile?.role === 'admin';
```

---

## Tasks / Subtasks

- [ ] **Task 1: Report System** (AC: 1, 2)
  - [ ] Create reports table migration
  - [ ] Implement `createReport(entityType, entityId, reason, description)` function
  - [ ] Add "Report" button to posts and comments
  - [ ] Test: report post, verify saved to database

- [ ] **Task 2: Admin Dashboard** (AC: 3, 10)
  - [ ] Create admin dashboard page (route: `/admin`)
  - [ ] Check admin role before rendering
  - [ ] Display platform statistics (user count, post count, etc.)
  - [ ] Display reports list with filtering
  - [ ] Test: access as admin, verify dashboard displays

- [ ] **Task 3: Moderation Actions** (AC: 4, 5, 6)
  - [ ] Create moderation_actions table migration
  - [ ] Implement admin actions: hide, delete, warn, suspend, ban
  - [ ] Log all actions to moderation_actions table
  - [ ] Display reported content with context
  - [ ] Test: perform action, verify content updated and action logged

- [ ] **Task 4: Moderation Queue Prioritisation** (AC: 7, 8)
  - [ ] Implement priority calculation (report count, severity, age)
  - [ ] Sort reports by priority in dashboard
  - [ ] Add admin notes field to reports
  - [ ] Test: verify high-priority reports appear first

- [ ] **Task 5: Automated Content Filtering** (AC: 9)
  - [ ] Create profanity/banned words list
  - [ ] Implement text filtering function
  - [ ] Flag posts/comments for review automatically
  - [ ] Test: post with banned word, verify flagged

- [ ] **Task 6: Integration Testing** (IV1, IV2, IV3)
  - [ ] Verify report button appears correctly
  - [ ] Test RLS prevents non-admins accessing reports
  - [ ] Performance test dashboard load time
  - [ ] Test audit log queryable

---

## Dev Notes

**Key Decisions:**
1. **Admin role**: Use `profiles.role = 'admin'` for access control
2. **Audit trail**: All moderation actions logged for transparency
3. **Priority queue**: Automated prioritisation reduces admin workload

**Gotchas:**
- Must prevent non-admins from accessing moderation endpoints
- Deleted content should be soft-deleted (flagged, not removed from DB)
- Automated filtering must not be too aggressive (false positives)

---

## Dev Agent Record

*To be populated by Dev Agent during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

