# Story 1.2: Social Feed Backend Integration with Real-Time Updates

## Status

**Draft**

---

## Story

**As a** user,  
**I want** the social feed to display real posts from the database with real-time updates,  
**so that** I can see genuine company activity and engage with colleagues' content as it happens.

---

## Acceptance Criteria

1. Posts are created, read, updated, and deleted from Supabase database (CRUD operations complete)
2. Feed displays posts from database with pagination (20 posts per page, infinite scroll)
3. Real-time updates: new posts appear in feed without refresh using Supabase real-time subscriptions
4. Post creation form validates input and saves to database with optimistic UI update
5. Post editing allows users to modify their own posts with edit history tracking
6. Post deletion removes post from database and updates feed (soft delete for audit trail)
7. Post author information correctly joined from users table (profile picture, name, role, department)
8. Like functionality increments/decrements like count in database with optimistic UI
9. Posts display accurate timestamps with relative formatting ("2 hours ago")
10. Feed loading states display skeleton loaders matching post card design

### Integration Verification

**IV1: Existing Functionality Verification**
- Existing `PostCard` component continues to render posts correctly
- `CreatePostCard` form validation and UI behaviour unchanged
- Feed pagination and infinite scroll still functional
- Post like button interaction remains smooth and responsive

**IV2: Integration Point Verification**
- `src/lib/api.ts` post functions successfully replaced with Supabase calls
- `src/components/feed/PostCard.tsx` correctly receives database post objects
- Real-time subscription cleanup prevents memory leaks on component unmount
- Feed updates do not cause scroll position jumping or UI flickering

**IV3: Performance Impact Verification**
- Initial feed load under 1.5 seconds
- Post creation appears in UI within 200ms (optimistic) and confirms from database within 500ms
- Real-time updates add new posts smoothly without performance degradation
- Scroll performance maintains 60fps with 50+ posts rendered

---

## Dev Technical Guidance

### Prerequisites
**This story depends on Story 1.1 (Database & Auth Foundation) being complete.**
- Database schema must be deployed
- Authentication must be working
- TypeScript types must be available

### Technology Stack
[Source: brownfield-architecture.md#Technical Summary]
- **Frontend**: React 18.3, TypeScript, Vite, Tailwind CSS
- **Backend**: Supabase (PostgreSQL database + real-time subscriptions)
- **State Management**: React Context API (`AppContext`)
- **API Client**: Supabase JavaScript client with TypeScript types

### Relevant Database Tables
[Source: supabase/migrations/20251115000000_complete_schema.sql]

**posts table:**
```sql
id: uuid (primary key)
user_id: uuid (foreign key to profiles)
content: text (post body)
attachment_type: text (image/video/document/null)
attachment_url: text (null allowed)
created_at: timestamptz
updated_at: timestamptz
```

**profiles table:**
```sql
id: uuid (primary key, auth.users reference)
name: text
avatar: text
role: text
department: text
```

**reactions table (for likes):**
```sql
id: uuid (primary key)
post_id: uuid (foreign key to posts)
user_id: uuid (foreign key to profiles)
type: text ('like', 'love', 'celebrate', 'insightful', 'curious')
created_at: timestamptz
UNIQUE(post_id, user_id) -- one reaction per user per post
```

### Supabase Real-Time Subscriptions
[Source: brownfield-architecture.md#Integration Points]

**Setup real-time listener for new posts:**
```typescript
const subscription = supabase
  .channel('posts_changes')
  .on('postgres_changes', 
    { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'posts' 
    }, 
    (payload) => {
      // Add new post to feed
    }
  )
  .subscribe();

// Cleanup on unmount
return () => {
  subscription.unsubscribe();
};
```

### Existing Code Context
[Source: brownfield-architecture.md#Source Tree and Module Organization]

**Files to modify:**
- `src/lib/api.ts` - Post CRUD functions (currently mock)
- `src/contexts/AppContext.tsx` - Posts state management
- `src/components/feed/PostCard.tsx` - Post rendering
- `src/pages/Home.tsx` - Feed page with real-time subscription

**Current mock data location:**
- `src/data/mockData.ts` - `mockPosts` array (will be replaced)

### Performance Considerations
[Source: brownfield-architecture.md#Performance]
- **Pagination**: Load 20 posts per page to avoid large initial queries
- **Optimistic UI**: Update UI immediately, confirm from database asynchronously
- **Real-time throttling**: Debounce real-time updates to prevent UI thrashing
- **Lazy loading**: Only subscribe to real-time when feed is visible

### Testing Requirements
[Source: Story requirements]
- Unit tests for post CRUD functions
- Integration tests for Supabase queries
- Real-time subscription lifecycle tests (subscribe/unsubscribe)
- Performance tests for feed load times
- UI tests for optimistic updates

---

## Tasks / Subtasks

- [ ] **Task 1: Update Post API Functions** (AC: 1, 4, 5, 6)
  - [ ] Replace `createPost()` in `src/lib/api.ts` with Supabase insert:
    ```typescript
    const { data, error } = await supabase
      .from('posts')
      .insert({ user_id, content, attachment_type, attachment_url })
      .select()
      .single();
    ```
  - [ ] Implement `updatePost()` with edit history tracking
  - [ ] Implement `deletePost()` as soft delete (add `deleted_at` column if needed)
  - [ ] Add error handling for all API functions
  - [ ] Test post creation/update/delete with real database

- [ ] **Task 2: Implement Feed Query with Pagination** (AC: 2, 7, 9)
  - [ ] Create `getPosts()` function in `src/lib/api.ts`:
    ```typescript
    const { data, error } = await supabase
      .from('posts')
      .select(`
        *,
        profiles:user_id (
          id, name, avatar, role, department
        )
      `)
      .order('created_at', { ascending: false })
      .range(0, 19); // First 20 posts
    ```
  - [ ] Add pagination support with `range(start, end)`
  - [ ] Implement infinite scroll trigger in feed component
  - [ ] Join user profile data in query (single query, no N+1)
  - [ ] Format timestamps as relative ("2 hours ago")
  - [ ] Test with 50+ posts to verify pagination

- [ ] **Task 3: Real-Time Post Updates** (AC: 3)
  - [ ] Set up Supabase real-time subscription in `src/pages/Home.tsx`:
    - Subscribe to `INSERT` events on `posts` table
    - Prepend new posts to feed state
    - Include author profile data in subscription
  - [ ] Implement subscription cleanup on component unmount
  - [ ] Test real-time: create post in different browser, verify it appears
  - [ ] Add debouncing to prevent UI thrashing from rapid updates
  - [ ] Handle edge case: user's own post should not duplicate (already shown optimistically)

- [ ] **Task 4: Optimistic UI Updates** (AC: 4, 8)
  - [ ] Update `AppContext.tsx` post creation:
    - Add post to local state immediately with temporary ID
    - Call Supabase insert in background
    - Replace temporary post with real post when confirmed
    - Revert on error with error message
  - [ ] Implement optimistic like/unlike:
    - Update UI like count immediately
    - Call Supabase in background
    - Revert on failure
  - [ ] Test: disable network, verify optimistic updates work
  - [ ] Test: re-enable network, verify database sync

- [ ] **Task 5: Loading States and Skeletons** (AC: 10)
  - [ ] Add loading state to feed component
  - [ ] Create skeleton loader component matching `PostCard` design
  - [ ] Display skeleton while initial posts load
  - [ ] Display loading indicator for pagination (bottom of feed)
  - [ ] Test: throttle network to 3G, verify skeletons appear

- [ ] **Task 6: Integration Testing and Performance Validation** (IV1, IV2, IV3)
  - [ ] Verify `PostCard` component renders database posts correctly
  - [ ] Verify form validation still works after Supabase integration
  - [ ] Test real-time subscription memory leaks (mount/unmount 10x)
  - [ ] Performance test: measure initial feed load time (target <1.5s)
  - [ ] Performance test: measure post creation time (optimistic <200ms, confirmed <500ms)
  - [ ] Performance test: scroll 50+ posts, verify 60fps maintained
  - [ ] Verify no scroll jumping when new posts appear
  - [ ] Test real-time updates don't degrade scroll performance

---

## Dev Notes

**Integration Approach:**
This story replaces mock post data with Supabase integration. The existing UI components should continue to work with minimal changes - we're just changing the data source.

**Key Technical Decisions:**
1. **Optimistic UI**: Update UI immediately for better UX, confirm from database asynchronously
2. **Real-time subscriptions**: Use Supabase channels for live updates without polling
3. **Pagination strategy**: Load 20 posts initially, infinite scroll for more
4. **Query optimization**: Join user profiles in single query to avoid N+1 problem

**Gotchas to Avoid:**
- Don't forget to unsubscribe from real-time channels on unmount (memory leak)
- Handle the case where user's own post appears via real-time (already shown optimistically)
- Soft delete posts rather than hard delete (for audit trail and data integrity)
- Test with poor network conditions to verify optimistic UI and error handling

**Testing Strategy:**
- Unit test each API function in isolation
- Integration test real-time subscriptions (subscribe/unsubscribe lifecycle)
- Performance test with realistic data volume (50+ posts)
- UI test optimistic updates (network disabled scenarios)

---

## Dev Agent Record

### Agent Model Used

*To be populated by Dev Agent during implementation*

### Debug Log References

*To be populated by Dev Agent during implementation*

### Completion Notes List

*To be populated by Dev Agent during implementation*

### File List

*To be populated by Dev Agent - List all files created, modified, or deleted during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

