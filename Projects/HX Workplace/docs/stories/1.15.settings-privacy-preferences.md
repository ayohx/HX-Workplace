# Story 1.15: Settings, Privacy, and User Preferences Enhancement

## Status

**Draft**

---

## Story

**As a** user,  
**I want** comprehensive settings to control my experience, privacy, and notifications,  
**so that** I can customise the platform to my preferences and protect my privacy.

---

## Acceptance Criteria

1. Settings page organised into sections: Account, Notifications, Privacy, Preferences, Security
2. Account settings: change password, update email, profile picture, bio, contact info
3. Notification settings: toggle email/push notifications per type (likes, comments, mentions, messages)
4. Privacy settings: profile visibility (public, colleagues only, private), show email/phone, allow messages from (everyone, colleagues, no one)
5. Preference settings: theme (light, dark, auto), language, timezone, date format
6. Security settings: two-factor authentication (2FA), active sessions list, security log (login history)
7. All settings saved to database and applied immediately without page refresh
8. Settings sync across devices (stored in database, not localStorage)
9. Export personal data: download all user data (posts, messages, profile) in JSON format (GDPR compliance)
10. Delete account: permanently delete user account and all associated data with confirmation

### Integration Verification

**IV1:** Existing settings page functional, form validation works, settings apply correctly  
**IV2:** Settings persist across logout/login, privacy controls enforce correctly, theme applies globally  
**IV3:** Settings save <300ms, page load <1s, data export generates <30s for 1000 posts

---

## Dev Technical Guidance

### Prerequisites
**Depends on Story 1.1 (Auth & Database) being complete.**

### Database Schema
[Source: profiles.settings field already exists]

**profiles.settings structure:**
```json
{
  "notifications": {
    "email": true,
    "push": true,
    "likes": true,
    "comments": true,
    "mentions": true,
    "messages": true
  },
  "privacy": {
    "profileVisibility": "public",
    "showEmail": false,
    "showPhone": false,
    "allowMessages": "everyone"
  },
  "preferences": {
    "theme": "auto",
    "language": "en",
    "timezone": "UTC",
    "dateFormat": "YYYY-MM-DD"
  }
}
```

### Two-Factor Authentication
Use Supabase Auth MFA:
```typescript
const { data, error } = await supabase.auth.mfa.enroll({
  factorType: 'totp'
});
```

---

## Tasks / Subtasks

- [ ] **Task 1: Settings Page Structure** (AC: 1)
  - [ ] Create settings page with tabbed sections
  - [ ] Sections: Account, Notifications, Privacy, Preferences, Security
  - [ ] Test: navigate between tabs, verify smooth UX

- [ ] **Task 2: Account Settings** (AC: 2)
  - [ ] Change password form (current password, new password, confirm)
  - [ ] Update email form with verification
  - [ ] Update profile picture and bio
  - [ ] Update contact info (phone, location, linkedin)
  - [ ] Test: update each field, verify saves

- [ ] **Task 3: Notification Settings** (AC: 3)
  - [ ] Toggle switches for each notification type
  - [ ] Save to `profiles.settings.notifications`
  - [ ] Apply settings to notification creation logic
  - [ ] Test: disable likes, verify no like notifications

- [ ] **Task 4: Privacy Settings** (AC: 4)
  - [ ] Profile visibility options: public, colleagues only, private
  - [ ] Show/hide email and phone toggles
  - [ ] Allow messages from: everyone, colleagues, no one
  - [ ] Save to `profiles.settings.privacy`
  - [ ] Enforce privacy controls in queries (RLS policies)
  - [ ] Test: set private profile, verify not visible to others

- [ ] **Task 5: Preference Settings** (AC: 5)
  - [ ] Theme selector: light, dark, auto (system)
  - [ ] Language dropdown (en, es, fr, etc.)
  - [ ] Timezone selector
  - [ ] Date format selector
  - [ ] Save to `profiles.settings.preferences`
  - [ ] Apply theme globally using Tailwind dark mode
  - [ ] Test: change theme, verify applies immediately

- [ ] **Task 6: Security Settings** (AC: 6)
  - [ ] Implement 2FA enrollment using Supabase Auth MFA
  - [ ] Display active sessions list
  - [ ] Security log: recent logins with IP, device, timestamp
  - [ ] Test: enable 2FA, verify login requires code

- [ ] **Task 7: Real-Time Settings Application** (AC: 7, 8)
  - [ ] Save settings to database immediately on change
  - [ ] Update AppContext state to reflect new settings
  - [ ] No page refresh required
  - [ ] Test: change setting, verify applies without refresh

- [ ] **Task 8: Export Personal Data** (AC: 9)
  - [ ] Create `exportUserData(userId)` function
  - [ ] Query all user posts, messages, profile data
  - [ ] Generate JSON file with all data
  - [ ] Trigger download in browser
  - [ ] Test: export data, verify complete and accurate

- [ ] **Task 9: Delete Account** (AC: 10)
  - [ ] Create `deleteAccount(userId)` function
  - [ ] Delete all user data: posts, messages, comments, reactions
  - [ ] Soft-delete profile (mark as deleted, anonymise)
  - [ ] Confirmation modal with password verification
  - [ ] Test: delete account, verify data removed

- [ ] **Task 10: Integration Testing** (IV1, IV2, IV3)
  - [ ] Verify settings persist across logout/login
  - [ ] Test privacy controls enforce correctly
  - [ ] Test theme applies globally
  - [ ] Performance test settings save <300ms
  - [ ] Performance test data export <30s

---

## Dev Notes

**Key Decisions:**
1. **Settings storage**: Use `profiles.settings` JSONB column for flexibility
2. **Real-time apply**: Settings take effect immediately via React state
3. **GDPR compliance**: Export and delete account features

**Gotchas:**
- Theme must apply to all components (use Tailwind dark mode class)
- Privacy settings must be enforced by RLS policies (not just UI)
- Delete account is permanent - require password confirmation

---

## Dev Agent Record

*To be populated by Dev Agent during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

