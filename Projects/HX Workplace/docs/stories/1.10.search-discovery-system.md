# Story 1.10: Search and Discovery System Integration

## Status

**Draft**

---

## Story

**As a** user,  
**I want** powerful global search across content and people with relevant results,  
**so that** I can quickly find information, posts, groups, and colleagues.

---

## Acceptance Criteria

1. Global search bar in header searches across: posts, people, groups, files
2. Search results display categorised by type: Posts, People, Groups, Files
3. Search relevance ranking prioritises: exact matches, recent content, engagement level
4. Search filters allow narrowing results: date range, content type, author, group
5. Search history saved per user (last 10 searches) for quick re-search
6. Saved searches allow users to bookmark frequent searches (e.g., "Marketing updates")
7. Trending content section shows most engaged posts from last 24 hours
8. Search results paginate efficiently (20 results per page, infinite scroll)
9. Search highlights matching text in results (bold search terms in post content)
10. Search performs full-text search in post content, comments, user bio, group descriptions

### Integration Verification

**IV1:** Existing `SearchPage` layout preserved, search input routes correctly, result cards use existing components  
**IV2:** PostgreSQL full-text search configured, indexes on searchable fields, filters maintain state  
**IV3:** Search results <500ms, autocomplete <200ms, non-blocking render, 10,000+ posts performant

---

## Dev Technical Guidance

### Prerequisites
**Depends on Stories 1.2 (Posts), 1.5 (Groups), 1.9 (People Directory) being complete.**

### PostgreSQL Full-Text Search
[Source: Supabase full-text search documentation]

**Create search index:**
```sql
-- Add tsvector column for full-text search
ALTER TABLE posts ADD COLUMN search_vector tsvector;
CREATE INDEX posts_search_idx ON posts USING gin(search_vector);

-- Update trigger to maintain search_vector
CREATE TRIGGER posts_search_vector_update
BEFORE INSERT OR UPDATE ON posts
FOR EACH ROW EXECUTE FUNCTION
tsvector_update_trigger(search_vector, 'pg_catalog.english', content);
```

**Search query:**
```typescript
const { data, error } = await supabase
  .from('posts')
  .select('*')
  .textSearch('search_vector', query, {
    type: 'websearch',
    config: 'english'
  });
```

### Trending Content Algorithm
```sql
-- Calculate engagement score (likes + comments * 2 + reactions)
-- Filter last 24 hours
-- Order by score descending
```

---

## Tasks / Subtasks

- [ ] **Task 1: Configure Full-Text Search** (AC: 10)
  - [ ] Add search_vector columns to posts, profiles, groups
  - [ ] Create GIN indexes for full-text search
  - [ ] Create triggers to update search vectors
  - [ ] Test: search for text, verify results

- [ ] **Task 2: Implement Global Search API** (AC: 1, 2, 3)
  - [ ] Create `globalSearch(query, filters)` function
  - [ ] Search across all entity types in parallel
  - [ ] Rank results by relevance and recency
  - [ ] Categorise results by type
  - [ ] Test: search query, verify categorised results

- [ ] **Task 3: Search Filters** (AC: 4)
  - [ ] Implement date range filter
  - [ ] Implement content type filter
  - [ ] Implement author filter
  - [ ] Implement group filter
  - [ ] Test: apply filters, verify correct results

- [ ] **Task 4: Search History and Saved Searches** (AC: 5, 6)
  - [ ] Save search queries to localStorage (last 10)
  - [ ] Implement saved searches in database
  - [ ] Display recent searches in search dropdown
  - [ ] Test: search, verify history saved

- [ ] **Task 5: Trending Content** (AC: 7)
  - [ ] Implement trending algorithm (engagement score)
  - [ ] Filter posts from last 24 hours
  - [ ] Cache trending results (update hourly)
  - [ ] Display trending section on search page
  - [ ] Test: verify trending posts correct

- [ ] **Task 6: Search Result Highlighting** (AC: 9)
  - [ ] Implement text highlighting for search terms
  - [ ] Bold matching text in results
  - [ ] Test: search, verify highlights visible

- [ ] **Task 7: Search Pagination** (AC: 8)
  - [ ] Implement pagination (20 results per page)
  - [ ] Add infinite scroll for more results
  - [ ] Test: search with many results, verify pagination

- [ ] **Task 8: Integration Testing** (IV1, IV2, IV3)
  - [ ] Performance test: search <500ms
  - [ ] Test full-text search with 10,000+ posts
  - [ ] Verify search indexes improve performance
  - [ ] Test autocomplete <200ms

---

## Dev Notes

**Key Decisions:**
1. **PostgreSQL full-text search**: Native database search for best performance
2. **Search vectors**: Pre-computed search indexes for fast results
3. **Trending cache**: Update hourly to reduce load

**Gotchas:**
- Full-text search requires GIN indexes (can be slow to build initially)
- Search relevance ranking requires tuning based on user feedback
- Trending content must exclude hidden/deleted posts

---

## Dev Agent Record

*To be populated by Dev Agent during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

