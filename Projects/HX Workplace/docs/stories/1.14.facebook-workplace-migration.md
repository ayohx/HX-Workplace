# Story 1.14: Facebook Workplace Data Migration Readiness

## Status

**Draft**

---

## Story

**As an** admin,  
**I want** tools to migrate data from Facebook Workplace to HX Workplace,  
**so that** we can preserve historical conversations, posts, and user data during transition.

---

## Acceptance Criteria

1. Data export format documented: map Facebook Workplace data structure to HX Workplace schema
2. Import scripts created for: users, posts, comments, groups, messages
3. Data transformation handles: date formats, user ID mapping, attachment URLs
4. Import process validates data before insertion (check required fields, referential integrity)
5. Migration runs in batches to avoid overwhelming database (1000 records per batch)
6. Migration progress tracked: import log shows success/failure per batch with error details
7. Dry-run mode available: test migration without committing data to database
8. User profile mapping: Facebook Workplace user IDs mapped to HX Workplace user IDs via email
9. Attachment migration: download files from Facebook Workplace, upload to Supabase Storage
10. Migration documentation: step-by-step guide for running migration, troubleshooting common issues

### Integration Verification

**IV1:** Migration scripts run without breaking existing data, imported data displays correctly in UI  
**IV2:** User mapping accurate (no duplicate users), attachments accessible after migration  
**IV3:** Migration performance: 10,000 posts imported in <10 minutes, no database locks during import

---

## Dev Technical Guidance

### Prerequisites
**All database schema complete (Stories 1.1-1.12 provide full schema).**

### Facebook Workplace Export Format
[Source: Facebook Workplace provides JSON export]

**Typical export structure:**
```json
{
  "users": [{"id": "fb_123", "name": "John Smith", "email": "john@company.com"}],
  "posts": [{"id": "post_456", "user_id": "fb_123", "content": "...", "created_time": "2024-01-15T10:30:00Z"}],
  "comments": [...],
  "groups": [...],
  "messages": [...]
}
```

### Migration Script Approach
```typescript
// 1. Create user ID mapping (Facebook ID -> HX ID)
const userMap = await createUserMapping(exportedUsers);

// 2. Import users
await importUsers(exportedUsers);

// 3. Import posts (map user_id using userMap)
await importPosts(exportedPosts, userMap);

// 4. Import comments
await importComments(exportedComments, userMap);

// 5. Import attachments
await migrateAttachments(exportedAttachments);
```

---

## Tasks / Subtasks

- [ ] **Task 1: Document Data Mapping** (AC: 1)
  - [ ] Document Facebook Workplace JSON structure
  - [ ] Map to HX Workplace database schema
  - [ ] Identify data transformations needed
  - [ ] Create mapping document: `docs/migration-mapping.md`

- [ ] **Task 2: User Profile Mapping** (AC: 8)
  - [ ] Create script to map Facebook user IDs to HX user IDs via email
  - [ ] Handle users without email (manual mapping required)
  - [ ] Export user mapping CSV for review
  - [ ] Test: map 100 users, verify accuracy

- [ ] **Task 3: Import Scripts** (AC: 2, 3)
  - [ ] Create `scripts/migration/importUsers.ts`
  - [ ] Create `scripts/migration/importPosts.ts`
  - [ ] Create `scripts/migration/importComments.ts`
  - [ ] Create `scripts/migration/importGroups.ts`
  - [ ] Create `scripts/migration/importMessages.ts`
  - [ ] Test: import sample data, verify in database

- [ ] **Task 4: Data Validation** (AC: 4)
  - [ ] Validate required fields before insert
  - [ ] Check referential integrity (user_id exists, post_id exists)
  - [ ] Log validation errors for review
  - [ ] Test: import invalid data, verify errors caught

- [ ] **Task 5: Batch Processing** (AC: 5)
  - [ ] Implement batch import (1000 records per batch)
  - [ ] Add delay between batches to prevent overload
  - [ ] Test: import 10,000 records in batches

- [ ] **Task 6: Migration Progress Tracking** (AC: 6)
  - [ ] Create migration log table or log file
  - [ ] Log batch status: batch number, records processed, success/failure
  - [ ] Display progress in console during import
  - [ ] Test: view logs, verify accuracy

- [ ] **Task 7: Dry-Run Mode** (AC: 7)
  - [ ] Add `--dry-run` flag to migration scripts
  - [ ] Dry-run validates and logs without inserting
  - [ ] Test: dry-run mode, verify no data committed

- [ ] **Task 8: Attachment Migration** (AC: 9)
  - [ ] Download attachments from Facebook Workplace URLs
  - [ ] Upload to Supabase Storage
  - [ ] Update attachment URLs in imported posts/messages
  - [ ] Test: migrate attachments, verify accessible

- [ ] **Task 9: Migration Documentation** (AC: 10)
  - [ ] Create `docs/MIGRATION_GUIDE.md`
  - [ ] Step-by-step instructions for running migration
  - [ ] Troubleshooting common issues
  - [ ] Rollback procedure if migration fails

- [ ] **Task 10: Integration Testing** (IV1, IV2, IV3)
  - [ ] Test full migration end-to-end
  - [ ] Verify imported data displays in UI
  - [ ] Performance test: 10,000 posts <10 minutes
  - [ ] Verify no data corruption or duplicates

---

## Dev Notes

**Key Decisions:**
1. **Email-based mapping**: Use email to match Facebook users to HX users
2. **Batch processing**: Import in batches to prevent database overload
3. **Dry-run testing**: Always test with dry-run first

**Gotchas:**
- Facebook timestamps may be in different timezone (convert to UTC)
- Attachments may be expired or inaccessible (log failures, skip)
- User mapping may not be 1:1 (some Facebook users may not have HX accounts yet)

---

## Dev Agent Record

*To be populated by Dev Agent during implementation*

---

## Change Log

| Date       | Version | Description                          | Author                |
| ---------- | ------- | ------------------------------------ | --------------------- |
| 2025-01-15 | 1.0     | Initial story creation from PRD Epic 1 | Bob (Scrum Master)  |

